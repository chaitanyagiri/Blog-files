<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Okay, so this comes after two frustrating days of reading documentations and finally getting the application in running state.http://www.mongodb.com/What is a replica set?As you might have guessed fro"><meta name="keywords" content="Chaitanya Giri,Tutorial,Javascript,MongoDB,NodeJS,NoSQL,Databases"><meta property="og:type" content="article"><meta property="og:title" content="MongoDB Replica set, Oplog and other ghosts that haunt you."><meta property="og:url" content="https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/index.html"><meta property="og:site_name" content="Chaitanya Giri Goswami"><meta property="og:description" content="Okay, so this comes after two frustrating days of reading documentations and finally getting the application in running state.http://www.mongodb.com/What is a replica set?As you might have guessed fro"><meta property="og:locale" content="en"><meta property="og:image" content="https://cdn-images-1.medium.com/max/2000/1*Ce0gUe0LbnhL7ebnDGTp5w.png"><meta property="og:image" content="https://cdn-images-1.medium.com/max/800/1*4m_iWLMgg7W3cu0mYjUNsw.jpeg"><meta property="og:image" content="https://cdn-images-1.medium.com/max/800/1*tDU3bK4zNcQDXP3TSDPKwA.jpeg"><meta property="og:updated_time" content="2018-06-19T07:21:29.704Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="MongoDB Replica set, Oplog and other ghosts that haunt you."><meta name="twitter:description" content="Okay, so this comes after two frustrating days of reading documentations and finally getting the application in running state.http://www.mongodb.com/What is a replica set?As you might have guessed fro"><meta name="twitter:image" content="https://cdn-images-1.medium.com/max/2000/1*Ce0gUe0LbnhL7ebnDGTp5w.png"><link rel="shortcut icon" href="/images/logo.png"><link rel="icon" type="image/png" href="/images/logo.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>MongoDB Replica set, Oplog and other ghosts that haunt you.</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/rtl.css"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fas fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/archives/">Writing</a></li><li><a href="https://chaitanyagiri.github.io/">Contact</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="/2018/04/06/Explaining-Reservation-in-India-to-a-complete-foreigner/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" href="/2018/01/10/How-I-became-a-mentor-in-Google-Code-In’17/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&text=MongoDB Replica set, Oplog and other ghosts that haunt you."><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&title=MongoDB Replica set, Oplog and other ghosts that haunt you."><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&is_video=false&description=MongoDB Replica set, Oplog and other ghosts that haunt you."><i class="fab fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=MongoDB Replica set, Oplog and other ghosts that haunt you.&body=Check out this article: https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/"><i class="fas fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&title=MongoDB Replica set, Oplog and other ghosts that haunt you."><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&title=MongoDB Replica set, Oplog and other ghosts that haunt you."><i class="fab fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&title=MongoDB Replica set, Oplog and other ghosts that haunt you."><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&title=MongoDB Replica set, Oplog and other ghosts that haunt you."><i class="fab fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.tumblr.com/share/link?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&name=MongoDB Replica set, Oplog and other ghosts that haunt you.&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#What-is-a-replica-set"><span class="toc-number">1.</span> <span class="toc-text">What is a replica set?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-does-it-work"><span class="toc-number">2.</span> <span class="toc-text">How does it work?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Now-how-can-you-actually-setup-a-replica-set-in-MongoDB"><span class="toc-number">3.</span> <span class="toc-text">Now how can you actually setup a replica set in MongoDB?</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Now-you-have-done-the-replication-part-you-need-to-do-is-set-up-MongoDB-Oplog-Tailing"><span class="toc-number">3.1.</span> <span class="toc-text">Now you have done the replication part you need to do is set up MongoDB Oplog Tailing.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Note-You-need-to-create-app-user-and-oplog-user-and-assign-roles-before-previous-step"><span class="toc-number">3.2.</span> <span class="toc-text">Note: You need to create app_user and oplog_user and assign roles before previous step.</span></a></li></ol></li></ol></div></span></div><div class="content index my4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">MongoDB Replica set, Oplog and other ghosts that haunt you.</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Chaitanya Giri</span></span><div class="postdate"><time datetime="2018-03-04T13:21:00.000Z" itemprop="datePublished">2018-03-04</time></div><div class="article-tag"><i class="fas fa-tag"></i> <a class="tag-link" href="/tags/Chaitanya-Giri/">Chaitanya Giri</a>, <a class="tag-link" href="/tags/Databases/">Databases</a>, <a class="tag-link" href="/tags/Javascript/">Javascript</a>, <a class="tag-link" href="/tags/MongoDB/">MongoDB</a>, <a class="tag-link" href="/tags/NoSQL/">NoSQL</a>, <a class="tag-link" href="/tags/NodeJS/">NodeJS</a>, <a class="tag-link" href="/tags/Tutorial/">Tutorial</a></div></div></header><div class="content" itemprop="articleBody"><p>Okay, so this comes after two frustrating days of reading documentations and finally getting the application in running state.</p><p><img src="https://cdn-images-1.medium.com/max/2000/1*Ce0gUe0LbnhL7ebnDGTp5w.png" alt=""></p><p><a href="http://www.mongodb.com/" target="_blank" rel="noopener">http://www.mongodb.com/</a></p><h3 id="What-is-a-replica-set"><a href="#What-is-a-replica-set" class="headerlink" title="What is a replica set?"></a><strong>What is a replica set?</strong></h3><p>As you might have guessed from the name it is a replica of the data set. Every now and then we suffer data loss and this can be crucial when it comes to huge data that are essential for a company to even <strong>exist.</strong> Suppose next day you wakeup and open amazon to buy something and you do not find a single product 😆. Now this is very less likely to happen because we have replica set. (Note: Amazon do not use mongodb to store data this was an example, though they use a NoSQL database so it has to be something similar).</p><p>Replica set has been in mongodb for a while now, previously instead of replica set we had master-slave replication(Please refer some other article if you want to learn about this).</p><h3 id="How-does-it-work"><a href="#How-does-it-work" class="headerlink" title="How does it work?"></a>How does it work?</h3><p>Basically a replica set is multiple set of mongod instances that hosts same data(this can be tricky to say as in any instance some data might be put after some delay but for the moment let’s assume as it is).</p><p><img src="https://cdn-images-1.medium.com/max/800/1*4m_iWLMgg7W3cu0mYjUNsw.jpeg" alt=""></p><p>MongoDB replica set</p><p>Now assume we have a primary node that has multiple secondary nodes(max 50) say 2 in this case. When ever client writes or reads from primary node the primary node logs it in its oplog. Now the two secondary nodes replicate the oplog’s operations and in-turn has the same data as primary. Now this nodes are connected with the primary node with a heartbeat kind of structure in if the primary node does not reply to their heartbeats in 10 seconds. Secondary nodes do an election sort of thing to replace primary node(😢 So rude). Now if there are less than 7 secondary nodes and total number of secondary node is even then there is an extra node called <strong>Arbiter</strong> it do not replicates it simply participate in election so that in the election a draw among nodes never happens and if there are 7 or more nodes then any 7 will participate based on their priority value(more details ahead).</p><p>Secondary nodes also have a priority value attached to them which helps in election. The extract of this statement can be: If a node has priority value 0 then it will never be elected and it’ll always have the data with it so it provides an extra layer of security to data loss.(Amazon is safe 😆).</p><p><img src="https://cdn-images-1.medium.com/max/800/1*tDU3bK4zNcQDXP3TSDPKwA.jpeg" alt=""></p><p>MongoDB replica and arbiter</p><h3 id="Now-how-can-you-actually-setup-a-replica-set-in-MongoDB"><a href="#Now-how-can-you-actually-setup-a-replica-set-in-MongoDB" class="headerlink" title="Now how can you actually setup a replica set in MongoDB?"></a>Now how can you actually setup a replica set in MongoDB?</h3><ul><li>By default, MongoDB bind to local interface only, it will restrict the remote connections. So <code>bind_ip</code> option tells MongoDB to accept connections from which local network interfaces. Below command specifies the replica set name and the ip binding through the <code>[--replSet](https://docs.mongodb.com/manual/reference/program/mongod/#cmdoption-mongod-replset)</code> and <code>[--bind_ip](https://docs.mongodb.com/manual/reference/program/mongod/#cmdoption-mongod-bind-ip)</code> command-line options.</li></ul><p>mongod –replSet “rs0” –bind_ip localhost,<hostname or="" ip="" address="" of="" mongod="" host=""></hostname></p><ul><li>Connect mongo shell to one of the mongod instances. In the shell use command <code>[rs.initiate()](https://docs.mongodb.com/manual/reference/method/rs.initiate/#rs.initiate &quot;rs.initiate()&quot;)</code>. It initiates a replica set, using the default replica set configuration.</li><li>Use <code>[rs.conf()](https://docs.mongodb.com/manual/reference/method/rs.conf/#rs.conf &quot;rs.conf()&quot;)</code> to display the <a href="https://docs.mongodb.com/manual/reference/replica-configuration/" target="_blank" rel="noopener">replica set configuration object</a>.</li><li>Use <code>[rs.status()](https://docs.mongodb.com/manual/reference/method/rs.status/#rs.status &quot;rs.status()&quot;)</code> to identify the primary in the replica set.</li></ul><h4 id="Now-you-have-done-the-replication-part-you-need-to-do-is-set-up-MongoDB-Oplog-Tailing"><a href="#Now-you-have-done-the-replication-part-you-need-to-do-is-set-up-MongoDB-Oplog-Tailing" class="headerlink" title="Now you have done the replication part you need to do is set up MongoDB Oplog Tailing."></a>Now you have done the replication part you need to do is set up MongoDB Oplog Tailing.</h4><p>Oplog Tailing means the application server will be notified real-time of any changes happening in the entire database.</p><p>In Meteor applications, when we talk about “oplog tailing” this means that the Meteor app is aware of this oplog, and watches it for changes, reflecting those changes in Meteor when those changes occur. In Meteor app, oplog tailing is turned on by default in our <em>development</em> environment, but requires a little extra work to get set up in our <em>production</em> environments.</p><p>MONGO_URL=’mongodb://app_user:<a href="mailto:app_passwd@127.0.0.1" target="_blank" rel="noopener">app_passwd@127.0.0.1</a>:27017/app_db’</p><p>MONGO_OPLOG_URL=mongodb://oplog_user:<a href="mailto:oplog_passwd@127.0.0.1" target="_blank" rel="noopener">oplog_passwd@127.0.0.1</a>:27017/local?authSource=admin</p><h4 id="Note-You-need-to-create-app-user-and-oplog-user-and-assign-roles-before-previous-step"><a href="#Note-You-need-to-create-app-user-and-oplog-user-and-assign-roles-before-previous-step" class="headerlink" title="Note: You need to create app_user and oplog_user and assign roles before previous step."></a>Note: You need to create app_user and oplog_user and assign roles before previous step.</h4><ul><li>To create Oplog user :</li></ul><p>use app_db</p><p>db.createUser({user: “oplog_user”, pwd: “oplog_passwd”, roles: [{role: “read”, db: “local”}]})</p><ul><li>To create App user :</li></ul><p>use app_db</p><p>db.createUser({ user: “app_user”, pwd: “app_passwd”, roles: [{ role: “dbOwner”, db: “app_db” }] });</p><p>Okay so this was it if you find it useful or if you liked it do clap for it. Follow me on <a href="https://medium.com/@chaitanyagiri" target="_blank" rel="noopener">medium,</a> <a href="https://github.com/chaitanyagiri" target="_blank" rel="noopener">github</a> for more such contents.</p></div></article></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/archives/">Writing</a></li><li><a href="https://chaitanyagiri.github.io/">Contact</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#What-is-a-replica-set"><span class="toc-number">1.</span> <span class="toc-text">What is a replica set?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-does-it-work"><span class="toc-number">2.</span> <span class="toc-text">How does it work?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Now-how-can-you-actually-setup-a-replica-set-in-MongoDB"><span class="toc-number">3.</span> <span class="toc-text">Now how can you actually setup a replica set in MongoDB?</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Now-you-have-done-the-replication-part-you-need-to-do-is-set-up-MongoDB-Oplog-Tailing"><span class="toc-number">3.1.</span> <span class="toc-text">Now you have done the replication part you need to do is set up MongoDB Oplog Tailing.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Note-You-need-to-create-app-user-and-oplog-user-and-assign-roles-before-previous-step"><span class="toc-number">3.2.</span> <span class="toc-text">Note: You need to create app_user and oplog_user and assign roles before previous step.</span></a></li></ol></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&text=MongoDB Replica set, Oplog and other ghosts that haunt you."><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&title=MongoDB Replica set, Oplog and other ghosts that haunt you."><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&is_video=false&description=MongoDB Replica set, Oplog and other ghosts that haunt you."><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=MongoDB Replica set, Oplog and other ghosts that haunt you.&body=Check out this article: https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&title=MongoDB Replica set, Oplog and other ghosts that haunt you."><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&title=MongoDB Replica set, Oplog and other ghosts that haunt you."><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&title=MongoDB Replica set, Oplog and other ghosts that haunt you."><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&title=MongoDB Replica set, Oplog and other ghosts that haunt you."><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.tumblr.com/share/link?url=https://chaitanyagiri.ga/2018/03/04/MongoDB-Replica-set-Oplog-and-other-ghosts-that-haunt-you/&name=MongoDB Replica set, Oplog and other ghosts that haunt you.&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2018 Chaitanya Giri</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/archives/">Writing</a></li><li><a href="https://chaitanyagiri.github.io/">Contact</a></li></ul></nav></div></footer></body></html><link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css"><link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script><script src="/js/main.js"></script><script type="text/javascript">!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script"),ga("create","UA-119188374-1","auto"),ga("send","pageview")</script>